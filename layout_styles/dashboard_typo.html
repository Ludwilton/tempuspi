<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=480, height=800, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
        }

        html, body {
            width: 480px;
            height: 800px;
            margin: 0; padding: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Space Grotesk', sans-serif;
            box-sizing: border-box;
        }

        .text-fluid-huge { font-size: 8rem; line-height: 0.8; letter-spacing: -0.05em; }
        .text-fluid-large { font-size: 3rem; line-height: 0.9; letter-spacing: -0.03em; }
        .text-fluid-mid { font-size: 1.8rem; line-height: 1; letter-spacing: -0.02em; }
        
        .divider-thick { border-bottom: 4px solid black; }
        .divider-thin { border-bottom: 1px solid #e5e5e5; }

        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex w-full h-full p-5">

    <aside class="w-[24px] flex flex-col items-center justify-between py-1 border-r border-gray-200 mr-5">
        <div class="vertical-text text-[9px] font-bold tracking-[0.2em] uppercase text-gray-800">
            SWEDEN
        </div>
        <div class="vertical-text text-[9px] font-bold tracking-[0.2em] uppercase text-gray-400">
            GOTHENBURG
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 h-full">

        <header class="flex flex-col pb-3 divider-thick relative">
            <div class="flex justify-between items-start pt-2 mb-3">
                <div class="flex flex-col">
                    <span class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-0.5">{{ datum_manad }}</span>
                    <span class="text-3xl font-bold uppercase leading-none tracking-tight">{{ datum_dag }}</span>
                </div>
                
                <div class="flex items-center gap-3">
                    <span class="text-3xl font-medium tracking-tight">{{ vader_temp }}°</span>
                    <i data-lucide="{{ vader_ikon }}" class="w-7 h-7 stroke-[1.5]"></i>
                </div>
            </div>

            {% if spotify and spotify.is_playing %}
                <div class="flex items-end justify-between">
                    <div class="font-bold text-[5rem] tracking-tighter -ml-2 text-black leading-none">
                        {{ klockslag }}
                    </div>
                    
                    <div class="flex items-end gap-3 min-w-0 flex-1 ml-4 pb-1">
                        <div class="flex flex-col justify-end min-w-0 flex-1">
                            <div class="font-bold text-lg leading-tight tracking-tight truncate">{{ spotify.track }}</div>
                            <div class="text-sm text-gray-600 leading-tight truncate">{{ spotify.artist }}</div>
                            <div class="text-xs text-gray-400 leading-tight truncate">{{ spotify.album }}</div>
                        </div>
                        <img src="{{ spotify.image }}" class="w-20 h-20 object-cover shadow-lg" alt="Album art">
                    </div>
                </div>
            {% else %}
                <div class="font-bold text-fluid-huge tracking-tighter -ml-2 text-black">
                    {{ klockslag }}
                </div>
            {% endif %}
        </header>

        <section class="flex-1 flex flex-col py-6 relative min-h-0">
            <div class="flex justify-between items-baseline mb-4">
                <h2 class="text-[10px] font-bold uppercase tracking-[0.2em] text-gray-400">Sequence</h2>
                <span class="text-[10px] font-mono text-gray-400">06:00 – 00:00</span>
            </div>

            <div class="h-[20px] flex w-full" id="calendar-header"></div>

            <div class="flex-1 relative w-full mt-2" id="calendar-body">
                <div class="absolute inset-0 flex flex-col justify-between py-1 pointer-events-none z-0">
                    <div class="w-full border-t border-dashed border-gray-200"></div>
                    <div class="w-full border-t border-dashed border-gray-200"></div>
                    <div class="w-full border-t border-dashed border-gray-200"></div>
                </div>
                <div id="calendar-columns" class="absolute inset-0 flex w-full h-full z-10 gap-2"></div>
            </div>
        </section>

        <section class="flex flex-col min-h-0 pt-4 border-t border-black shrink-0">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-fluid-mid font-bold leading-none tracking-tight truncate max-w-[70%]">
                    {{ hallplats_namn | default('DEPARTURES') }}
                </h2>
                <span class="text-[9px] font-bold bg-black text-white px-2 py-1 rounded-sm tracking-wider">NOW</span>
            </div>

            <div id="bus-list" class="flex-1 flex flex-col overflow-hidden max-h-[180px]">
                {% if avgangar %}
                    {% for bus in avgangar[:3] %}
                    <div class="flex items-baseline py-3 border-b border-gray-100 group">
                        <div class="w-12 font-bold text-2xl leading-none tracking-tight">
                            {{ bus.line }}
                        </div>
                        <div class="flex-1 min-w-0 px-2">
                            <div class="font-medium text-lg leading-none truncate tracking-tight text-gray-800">
                                {{ bus.destination }}
                            </div>
                        </div>
                        <div class="w-auto text-right flex items-baseline gap-2">
                            <span class="font-bold text-2xl leading-none">{{ bus.next }}</span>
                            <span class="text-xs text-gray-400 font-medium">{{ bus.later }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="flex-1 flex items-center justify-center flex-col opacity-30">
                        <span class="font-medium text-sm tracking-widest uppercase">No Connection</span>
                    </div>
                {% endif %}
            </div>
        </section>

    </main>

    <script>
        window.onload = function() {
            if (window.lucide) { lucide.createIcons(); } 
            else { setTimeout(() => { if (window.lucide) lucide.createIcons(); }, 500); }
        };

        const daysFromPython = {{ kalender_dagar | tojson }};

        function renderCalendar() {
            const headerContainer = document.getElementById('calendar-header');
            const columnsContainer = document.getElementById('calendar-columns');
            const startHour = 6;
            const totalHours = 18; 
            
            function getTopPercent(hour) {
                if (!hour) return 0;
                if (hour < startHour) return 0; 
                if (hour > 24) return 100;     
                return ((hour - startHour) / totalHours) * 100;
            }

            let headerHtml = '';
            let columnsHtml = '';

            daysFromPython.forEach((dayData) => {
                const isToday = dayData.is_today;
                const widthClass = isToday ? 'w-2/5' : 'flex-1'; 
                const textColor = isToday ? 'text-black font-bold' : 'text-gray-300 font-normal';
                
                headerHtml += `
                    <div class="${widthClass} flex items-end justify-center text-[10px] uppercase tracking-wider ${textColor}">
                        ${dayData.namn}
                    </div>
                `;

                let dayEventsHtml = '';

                if (dayData.events && dayData.events.length > 0) {
                    dayData.events.forEach((evt) => {
                        const start = evt.start || 8; 
                        const end = evt.end || 9;
                        const top = getTopPercent(start);
                        let height = ((end - start) / totalHours) * 100;
                        if (height < 4) height = 4;

                        if (isToday) {
                            dayEventsHtml += `
                                <div class="absolute w-full z-20" style="top: ${top}%; height: ${height}%;">
                                    <div class="bg-black text-white w-full h-full flex flex-col justify-center p-1.5 shadow-lg border-b border-white overflow-hidden">
                                        <span class="font-medium text-[10px] leading-tight text-center break-words">${evt.name}</span>
                                    </div>
                                </div>
                            `;
                        } else {
                            dayEventsHtml += `
                                <div class="absolute w-full z-10" style="top: ${top}%; height: ${height}%;">
                                    <div class="bg-gray-100 w-full h-full border-b border-white" title="${evt.name}"></div>
                                </div>
                            `;
                        }
                    });
                }

                columnsHtml += `
                    <div class="${widthClass} relative h-full">
                        ${dayEventsHtml}
                    </div>
                `;
            });

            headerContainer.innerHTML = headerHtml;
            columnsContainer.innerHTML = columnsHtml;
        }

        if (daysFromPython && daysFromPython.length > 0) renderCalendar();
    </script>
</body>
</html>