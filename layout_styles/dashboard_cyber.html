<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=480, height=800, initial-scale=1.0">
    <title>Award Winning Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;800&family=Archivo+Black&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --border-thick: 4px solid black;
            --border-thin: 2px solid black;
        }

        .pattern-grid {
            background-image: 
                linear-gradient(black 1px, transparent 1px),
                linear-gradient(90deg, black 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: -1px -1px;
        }

        .pattern-dots {
            background-image: radial-gradient(black 1px, transparent 1px);
            background-size: 4px 4px;
        }

        html, body {
            width: 480px;
            height: 800px;
            margin: 0; padding: 0;
            overflow: hidden;
            background-color: white;
            color: black;
            font-family: 'JetBrains Mono', monospace;
            box-sizing: border-box;
        }

        .font-heavy { font-family: 'Archivo Black', sans-serif; }
        
        .b-b { border-bottom: var(--border-thick); }
        .b-t { border-top: var(--border-thick); }
        .b-r { border-right: var(--border-thick); }
        .b-l { border-left: var(--border-thick); }
        
        .b-b-thin { border-bottom: var(--border-thin); }
        .b-r-thin { border-right: var(--border-thin); }

        .inverted { background-color: black; color: white; }
        
        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex w-full h-full border-[8px] border-black">

    <aside class="w-[40px] b-r flex flex-col items-center justify-between py-2 bg-white pattern-dots">
        <div class="vertical-text text-[10px] font-bold tracking-widest uppercase">
            SYS_RDY // V.2.7
        </div>
        <div class="h-1/3 w-[2px] bg-black my-2"></div>
        <div class="vertical-text text-[10px] font-bold tracking-widest uppercase">
            LAT 57.70 // LON 11.96
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0">

        <header class="h-[170px] flex flex-col b-b">
            <div class="h-[30px] flex b-b-thin">
                <div class="flex-1 px-3 flex items-center text-sm font-bold uppercase tracking-tighter bg-black text-white">
                    {{ datum_dag }}
                </div>
                <div class="px-3 flex items-center text-sm font-bold uppercase b-l inverted">
                    {{ datum_manad }}
                </div>
            </div>

            <div class="flex-1 flex">
                <div class="flex-1 flex items-center justify-center relative overflow-hidden">
                    <span class="absolute text-[9rem] opacity-5 font-heavy -top-4 -left-4 select-none"></span>
                    <div class="font-heavy text-[6.5rem] leading-none tracking-tighter z-10">
                        {{ klockslag }}
                    </div>
                </div>
                
                <div class="w-[110px] b-l flex flex-col">
                    <div class="flex-1 flex flex-col items-center justify-center b-b-thin bg-white">
                        <i data-lucide="{{ vader_ikon }}" class="w-10 h-10 stroke-[3] mb-1"></i>
                    </div>
                    <div class="h-[50px] flex items-center justify-center font-heavy text-3xl bg-black text-white">
                        {{ vader_temp }}°
                    </div>
                </div>
            </div>
        </header>

        <section class="h-[370px] flex flex-col b-b relative">
            <div class="absolute top-0 left-0 bg-black text-white text-[9px] px-1 py-0.5 z-30 font-bold uppercase">
                Schedule
            </div>

            <div class="h-[25px] flex b-b-thin" id="calendar-header"></div>

            <div class="flex-1 relative w-full pattern-grid" id="calendar-body">
                <div class="absolute inset-0 flex flex-col justify-between py-2 pl-1 pointer-events-none opacity-60 z-0">
                    <span class="text-[9px] bg-white px-1 w-fit border border-black">06:00</span>
                    <span class="text-[9px] bg-white px-1 w-fit border border-black">12:00</span>
                    <span class="text-[9px] bg-white px-1 w-fit border border-black">18:00</span>
                    <span class="text-[9px] bg-white px-1 w-fit border border-black">21:00</span>
                </div>
                <div id="calendar-columns" class="absolute inset-0 flex w-full h-full z-10"></div>
            </div>
        </section>

        <section class="flex-1 flex flex-col min-h-0 bg-white">
            <div class="h-[30px] flex items-center bg-black text-white px-2 justify-between">
                <span class="text-xs font-bold uppercase tracking-widest flex items-center">
                    <i data-lucide="bus" class="w-3 h-3 mr-2"></i>
                    {{ hallplats_namn | default('DEPARTURES') }}
                </span>
                <span class="text-[9px] font-mono">LIVE_DATA</span>
            </div>

            <div id="bus-list" class="flex-1 flex flex-col">
                <div class="flex h-[20px] items-center text-[10px] font-bold uppercase border-b-2 border-black bg-gray-100">
                    <div class="w-12 text-center border-r border-black">Line</div>
                    <div class="flex-1 pl-2">Dest</div>
                    <div class="w-24 text-right pr-2 border-l border-black">Next</div>
                    <div class="w-16 text-right pr-2 border-l border-black text-gray-500">Later</div>
                </div>

                {% if avgangar %}
                    {% for bus in avgangar[:4] %}
                    <div class="flex items-center h-[54px] border-b border-black w-full relative group">
                        <div class="w-12 h-full flex items-center justify-center border-r border-black bg-black text-white">
                            <span class="font-heavy text-xl">{{ bus.line }}</span>
                        </div>
                        
                        <div class="flex-1 pl-2 pr-1 min-w-0">
                            <div class="font-bold text-lg leading-tight truncate uppercase tracking-tight">
                                {{ bus.destination }}
                            </div>
                        </div>

                        <div class="w-24 h-full flex items-center justify-end pr-2 border-l border-black">
                            <span class="font-heavy text-2xl">{{ bus.next }}</span>
                        </div>

                        <div class="w-16 h-full flex items-center justify-end pr-2 border-l border-black bg-gray-50 pattern-dots">
                            <span class="font-bold text-sm">{{ bus.later }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="flex-1 flex items-center justify-center flex-col">
                        <span class="font-bold text-lg">NO SIGNAL</span>
                        <span class="text-xs">Retry in 60s</span>
                    </div>
                {% endif %}
            </div>
        </section>

    </main>

    <script>
        window.onload = function() {
            if (window.lucide) { lucide.createIcons(); } 
            else { setTimeout(() => { if (window.lucide) lucide.createIcons(); }, 500); }
        };

        const daysFromPython = {{ kalender_dagar | tojson }};

        function renderCalendar() {
            const headerContainer = document.getElementById('calendar-header');
            const columnsContainer = document.getElementById('calendar-columns');
            const startHour = 6;
            const totalHours = 18; 
            
            function getTopPercent(hour) {
                if (!hour) return 0;
                if (hour < startHour) return 0; 
                if (hour > 24) return 100;     
                return ((hour - startHour) / totalHours) * 100;
            }

            let headerHtml = '';
            let columnsHtml = '';

            daysFromPython.forEach((dayData) => {
                const isToday = dayData.is_today;
                const widthClass = isToday ? 'w-2/6' : 'flex-1'; 
                
                const headerBg = isToday ? 'bg-black text-white' : 'bg-white text-black';
                const headerBorder = 'border-r-2 border-black';
                
                headerHtml += `
                    <div class="${widthClass} ${headerBorder} ${headerBg} h-full flex items-center justify-center text-xs font-bold">
                        ${dayData.namn}
                    </div>
                `;

                let dayEventsHtml = '';
                
                // HÄR ÄR FIXEN: Vi loopar igenom 'events' (plural) listan
                if (dayData.events && dayData.events.length > 0) {
                    dayData.events.forEach((evt) => {
                        const start = evt.start || 8; 
                        const end = evt.end || 9;
                        const top = getTopPercent(start);
                        let height = ((end - start) / totalHours) * 100;
                        if (height < 4) height = 4; 

                        if (isToday) {
                            dayEventsHtml += `
                                <div class="absolute w-full px-0.5 z-20" style="top: ${top}%; height: ${height}%;">
                                    <div class="bg-black text-white w-full h-full border border-white flex flex-col justify-center p-1 shadow-[2px_2px_0px_0px_rgba(0,0,0,0.5)] overflow-hidden">
                                        <span class="font-bold text-xs font-mono leading-tight uppercase break-words whitespace-normal text-center">${evt.name}</span>
                                    </div>
                                </div>
                            `;
                        } else {
                            dayEventsHtml += `
                                <div class="absolute w-full px-0.5 z-10" style="top: ${top}%; height: ${height}%;">
                                    <div class="bg-white w-full h-full border-2 border-black" title="${evt.name}"></div>
                                </div>
                            `;
                        }
                    });
                }

                const colBg = isToday ? 'bg-white' : ''; 
                
                columnsHtml += `
                    <div class="${widthClass} relative border-r border-black h-full ${colBg}">
                        ${dayEventsHtml}
                    </div>
                `;
            });

            headerContainer.innerHTML = headerHtml;
            columnsContainer.innerHTML = columnsHtml;
        }

        if (daysFromPython && daysFromPython.length > 0) renderCalendar();
    </script>
</body>
</html>